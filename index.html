<html>
  <head>
    <title>Tacit Help - Transform tacit APL into dfn form</title>
    <meta charset="utf-8" />
    <script src="msgpack.min.js"></script>
    <link rel="stylesheet" href="/index.css">
    <link rel="icon" href="favicon.svg" sizes="any" type="image/svg+xml">
    <script src="explicit.js"></script> 
  </head>
  <body>
      <h1>Transform tacit APL into dfn form</h1>
    <main>
      <div class="container">
        <label for="expr"><pre>f ←</pre></label>
        <input id="expr" autofocus autocomplete="off" spellcheck="false" oninput="f()" placeholder="+⌿÷⊣∘≢"/>
        <a class="circle" title="copy query URL" href="#" onclick="Copy()">#</a>
      </div>
      <section>
      <div class="container">
        <label for="prfx"><pre>f Y</pre> ⇔</label>
      <pre class="o" id="prfx"> </pre>
    </div>
    <div class="container">
        <label for="infx"><pre>X f Y</pre> ⇔</label>
    <pre class="o" id="infx"> </pre>
    </div>
    </section>
    </main>
    <footer>
      Please <a
        href=https://github.com/awagga/tacit.help/issues/new?assignees=&labels=&template=internal-server-error.md&title=https%3A%2F%2Ftacit.help%2F%3Ff%3D">report</a>
      "Internal Server Error"s to improve the quality of this system
    </footer>
  </body>
  <script>

    const w = window

    const params = new URLSearchParams(w.location.search);
    const i = document.getElementById("expr");
    
    f = async () => {

      if (i.value == "") {
       document.getElementById("prfx").textContent = "{((+⌿)⍵)÷(≢⍵)}";
       document.getElementById("infx").textContent = "{(⍺(+⌿)⍵)÷⍺}";
     }

      let socket = new WebSocket("wss://dyalog.run/api/v0/ws/execute");

      socket.onopen = () => {
       if (i.value){socket.send(MessagePack.encode({language: "dyalog_apl",code: explicit + "\n ⎕ ← ⎕JSON explicit '" + i.value.replace(/\'/g, "''") + "'",timeout: 5,}));}
      }

      socket.onmessage = async (event) => {
        try {
         const values = JSON.parse(new TextDecoder().decode((await MessagePack.decodeAsync(event.data.stream())).stdout));
         document.getElementById("prfx").textContent = values[0];
         document.getElementById("infx").textContent = values[1];
        } catch {
         document.getElementById("prfx").textContent = 'Internal Server Error';
         document.getElementById("infx").textContent = 'Internal Server Error';
       }
      };
    }

    Copy = () =>{
      w.history.replaceState({},w.document.title,w.location.pathname + ("?f=" + encodeURIComponent(i.value)))
      navigator.clipboard.writeText(w.location.toString().replace("#",""))
    }
    
    if (params.get("f") != null) { i.value = decodeURIComponent(params.get("f")); }
    f()

  </script>
</html>
