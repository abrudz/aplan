<html>
  <head>
    <title>Tacit Help - Transform tacit APL into dfn form</title>
    <meta charset="utf-8" />
    <script src="msgpack.min.js"></script>
    <link rel="stylesheet" href="/index.css">
    <link rel="icon" href="favicon.svg" sizes="any" type="image/svg+xml">
  </head>
  <body>
      <h1>Transform tacit APL into dfn form</h1>
    <main>
      <div class="container">
        <label for="expr"><pre>f ←</pre></label>
        <input id="expr" autocomplete="off" spellcheck="false" oninput="f()" placeholder="+⌿÷⊣∘≢"/>
        <a class="circle" title="copy query URL" href="#" onclick="Copy()">#</a>
      </div>
      <section>
      <div class="container">
        <label for="prfx"><pre>f Y</pre> ⇔</label>
      <pre class="o" id="prfx"> </pre>
    </div>
    <div class="container">
        <label for="infx"><pre>X f Y</pre> ⇔</label>
    <pre class="o" id="infx"> </pre>
    </div>
    </section>
    </main>
  </body>

  <script>

    const w = window
    const header = `
    2 ⎕fix 'file:///opt/mdyalog/18.2/64/unicode/SALT/core/Utils.dyalog'
    repObj ← Utils.repObj
    `

    const params = new URLSearchParams(w.location.search);
    const input = document.getElementById("expr");
    
    f = async () => {
      const explicit = await fetch("explicit.aplf").then((r) => r.text());
      let socket = new WebSocket("wss://dyalog.run/api/v0/ws/execute");

      let expr = input.value.replace(/\'/g, "''");
      socket.onopen = () => {
      if (expr){
        socket.send(
          MessagePack.encode({
            language: "dyalog_apl",
            code: header + explicit + "\n ⎕ ← ⎕JSON explicit '" + expr + "'",
            timeout: 5,
          })
        );
    } else if (params.get("f") == null || expr.value != "") {
      document.getElementById("prfx").textContent = "{((+⌿)⍵)÷(≢⍵)}Y";
      document.getElementById("infx").textContent = "X{(⍺(+⌿)⍵)÷⍺}Y";
    }
  }

      socket.onmessage = async (event) => {
        const values = JSON.parse(
          new TextDecoder().decode(
            (await MessagePack.decodeAsync(event.data.stream())).stdout
          )
        );
        document.getElementById("prfx").textContent = values[0];
        document.getElementById("infx").textContent = values[1];
      };
    }

    Copy = () =>{
      w.history.replaceState({},w.document.title,w.location.pathname + ("?f=" + encodeURIComponent(input.value)))
      navigator.clipboard.writeText(w.location.toString().replace("#",""))
    }
      if (params.get("f") != null) { 
        input.value = decodeURIComponent(params.get("f")); 
      }

     f()

  </script>
</html>
